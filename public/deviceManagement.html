<!DOCTYPE html>
<html>
<head>
    <title>Device Management - Network Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/lucide-icons@0.263.1/font/lucide-icons.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }

        .header {
            background: #2d2d2d;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-button {
            background: none;
            border: none;
            color: #fdfdfd;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .device-panel {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scan-btn {
            padding: 10px 20px;
            background: #4CAF50;
            border: none;
            border-radius: 4px;
            color: rgb(255, 255, 255);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .scan-btn:hover {
            background: #45a049;
        }

        .scan-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* New Action Bank Styles */
        .action-bank {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #3d3d3d;
            border-radius: 4px;
            align-items: center;
            flex-wrap: wrap;
        }

        .action-bank .selected-count {
            margin-right: auto;
            padding: 8px 12px;
            background: #2d2d2d;
            border-radius: 4px;
            font-size: 0.9em;
            min-width: 150px;
        }

        .action-bank .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .action-bank .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-bank .btn-monitor { background: #2196F3; }
        .action-bank .btn-monitor:hover:not(:disabled) { background: #1976D2; }

        .action-bank .btn-block { background: #f44336; }
        .action-bank .btn-block:hover:not(:disabled) { background: #d32f2f; }

        .action-bank .btn-trust { background: #4CAF50; }
        .action-bank .btn-trust:hover:not(:disabled) { background: #388E3C; }

        .action-bank .btn-rename { background: #FFC107; }
        .action-bank .btn-rename:hover:not(:disabled) { background: #FFA000; }

        .action-bank .btn-check { background: #9C27B0; }
        .action-bank .btn-check:hover:not(:disabled) { background: #7B1FA2; }

        /* Table Styles */
        .device-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .device-table th,
        .device-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3d3d3d;
        }

        .device-table th {
            background: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .device-table tr:hover {
            background: #333;
        }

        .device-table tr.selected {
            background: #1e3a2d;
        }

        .device-table tr.selected:hover {
            background: #2a4a3d;
        }

        /* Checkbox Styles */
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .device-checkbox,
        #selectAll {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #4CAF50;
        }

        /* Status Indicator Styles */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online { 
            background: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }

        .status-offline { 
            background: #f44336;
            box-shadow: 0 0 5px #f44336;
        }

        /* Badge Styles */
        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }

        .badge-warning {
            background: #ff9800;
            color: #000;
        }

        .badge-success {
            background: #4CAF50;
            color: #fff;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 10px;
            }
            
            .action-bank {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-bank .selected-count {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .device-table {
                font-size: 14px;
            }
        }

        @media (max-width: 768px) {
            .device-panel {
                padding: 10px;
            }
            
            .device-table th,
            .device-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-button" onclick="window.location.href='/'">
            ‚Üê Back to Dashboard
        </button>
        <h1>Device Management</h1>
    </div>

    <div class="container">
        <!-- Network Devices Panel -->
        <div class="device-panel">
            <div class="panel-header">
                <h2>Network Devices</h2>
                <button class="scan-btn" onclick="scanNetwork()">Scan Network</button>
            </div>

            <!-- Action Bank -->
            <div class="action-bank">
                <div class="selected-count">0 devices selected</div>
                <button class="action-btn btn-monitor" onclick="batchAction('monitor')" disabled>
                    üìä Monitor
                </button>
                <button class="action-btn btn-trust" onclick="batchAction('trust')" disabled>
                    ‚úì Trust
                </button>
                <button class="action-btn btn-rename" onclick="batchAction('rename')" disabled>
                    ‚úé Rename
                </button>
                <button class="action-btn btn-block" onclick="batchAction('block')" disabled>
                    ‚õî Block
                </button>
                <button class="action-btn btn-check" onclick="batchAction('check')" disabled>
                    üîç Check State
                </button>
            </div>

            <table class="device-table">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAll" onclick="toggleAllDevices()">
                        </th>
                        <th>Status</th>
                        <th>Device Name</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Type</th>
                        <th>History</th>
                    </tr>
                </thead>
                <tbody id="deviceTableBody">
                    <!-- Devices will be listed here -->
                </tbody>
            </table>
        </div>

        <!-- Subnet Devices Panel -->
        <div class="device-panel">
            <div class="panel-header">
                <h2>Subnet Devices</h2>
                <button class="scan-btn" onclick="scanSubnets()">Scan Subnets</button>
            </div>

            <!-- Subnet Action Bank -->
            <div class="action-bank">
                <div class="selected-count">0 subnet devices selected</div>
                <button class="action-btn btn-monitor" onclick="batchSubnetAction('monitor')" disabled>
                    üìä Monitor
                </button>
                <button class="action-btn btn-check" onclick="batchSubnetAction('check')" disabled>
                    üîç Check Details
                </button>
            </div>
    
            <table class="device-table">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAllSubnet" onclick="toggleAllSubnetDevices()">
                        </th>
                        <th>Subnet</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Hostname</th>
                        <th>Gateway</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody id="subnetTableBody">
                    <!-- Subnet devices will be listed here -->
                </tbody>
            </table>
        </div>
    </div>

    <template id="deviceRowTemplate">
        <tr data-mac="">
            <td class="checkbox-cell">
                <input type="checkbox" class="device-checkbox">
            </td>
            <td>
                <span class="status-indicator"></span>
                <span class="status-text"></span>
            </td>
            <td class="device-name"></td>
            <td class="ip-address"></td>
            <td class="mac-address"></td>
            <td class="device-type"></td>
            <td class="device-history"></td>
        </tr>
    </template>

    <template id="subnetDeviceRowTemplate">
        <tr data-ip="">
            <td class="checkbox-cell">
                <input type="checkbox" class="subnet-device-checkbox">
            </td>
            <td class="subnet"></td>
            <td class="ip-address"></td>
            <td class="mac-address"></td>
            <td class="hostname"></td>
            <td class="gateway"></td>
            <td class="last-seen"></td>
        </tr>
    </template>

<script>
    // State Management
    let devices = [];
    let subnetDevices = new Map();
    let selectedDevices = new Set();
    let selectedSubnetDevices = new Set();
    let ws;

    // Initialize WebSocket
    function initializeWebSocket() {
        ws = new WebSocket('ws://localhost:8765');
        
        ws.onopen = () => {
            console.log('WebSocket connected');
        };
        
        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'subnet_scan') {
                handleSubnetScanMessage(message.data);
            }
        };
        
        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = () => {
            console.log('WebSocket disconnected');
            setTimeout(initializeWebSocket, 5000);
        };
    }

    function handleSubnetScanMessage(data) {
        const tbody = document.getElementById('subnetTableBody');
        
        switch (data.type) {
            case 'device_found':
                subnetDevices.set(data.device.ip, data.device);
                updateSubnetTable();
                break;
                
            case 'progress':
                const scanBtn = document.querySelector('.device-panel:nth-child(2) .scan-btn');
                scanBtn.textContent = 'Scanning...';
                if (!subnetDevices.size) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center;">${data.message}</td></tr>`;
                }
                break;
                
            case 'error':
                console.error('Subnet scan error:', data.message);
                break;
                
            case 'scan_complete':
                const scanButton = document.querySelector('.device-panel:nth-child(2) .scan-btn');
                scanButton.disabled = false;
                scanButton.textContent = 'Scan Subnets';
                
                if (!subnetDevices.size) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No subnet devices found</td></tr>';
                }
                break;
        }
    }

    // Action Button Management
    function updateActionButtons(isSubnet = false) {
        const selectedSet = isSubnet ? selectedSubnetDevices : selectedDevices;
        const count = selectedSet.size;
        const countDisplay = document.querySelector(isSubnet ? 
            '.device-panel:nth-child(2) .selected-count' : 
            '.device-panel:first-child .selected-count'
        );
        
        countDisplay.textContent = `${count} device${count !== 1 ? 's' : ''} selected`;
        
        const actionBank = countDisplay.closest('.action-bank');
        const buttons = actionBank.querySelectorAll('.action-btn');
        buttons.forEach(btn => {
            btn.disabled = count === 0;
            btn.classList.toggle('active', count > 0);
        });
    }

    // Device Selection Handlers
    function toggleDevice(identifier, checked, isSubnet = false) {
        const selectedSet = isSubnet ? selectedSubnetDevices : selectedDevices;
        if (checked) {
            selectedSet.add(identifier);
        } else {
            selectedSet.delete(identifier);
        }
        
        const row = document.querySelector(`tr[data-${isSubnet ? 'ip' : 'mac'}="${identifier}"]`);
        if (row) {
            row.classList.toggle('selected', checked);
        }
        
        updateActionButtons(isSubnet);
    }

    function toggleAllDevices(isSubnet = false) {
        const selectAllCheckbox = document.getElementById(isSubnet ? 'selectAllSubnet' : 'selectAll');
        const deviceCheckboxes = document.querySelectorAll(isSubnet ? 
            '.subnet-device-checkbox' : 
            '.device-checkbox'
        );
        
        deviceCheckboxes.forEach(checkbox => {
            const identifier = checkbox.closest('tr').dataset[isSubnet ? 'ip' : 'mac'];
            checkbox.checked = selectAllCheckbox.checked;
            toggleDevice(identifier, selectAllCheckbox.checked, isSubnet);
        });
    }

    // Network Scanning Functions
    async function scanNetwork() {
        const scanBtn = document.querySelector('.device-panel:first-child .scan-btn');
        const tbody = document.getElementById('deviceTableBody');
        
        try {
            scanBtn.disabled = true;
            scanBtn.textContent = 'Scanning...';
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Scanning network...</td></tr>';

            const response = await fetch('/api/scan-network');
            if (!response.ok) throw new Error('Network scan failed');
            
            devices = await response.json();
            
            tbody.innerHTML = devices.map(device => `
                <tr data-mac="${device.mac}">
                    <td class="checkbox-cell">
                        <input type="checkbox" 
                            class="device-checkbox" 
                            value="${device.mac}"
                            onchange="toggleDevice('${device.mac}', this.checked)">
                    </td>
                    <td>
                        <span class="status-indicator ${device.online ? 'status-online' : 'status-offline'}"></span>
                        ${device.online ? 'Online' : 'Offline'}
                    </td>
                    <td>${device.name || device.custom_name || device.hostname || 'Unknown'}</td>
                    <td>${device.ip}</td>
                    <td>
                        ${device.mac}
                        ${device.isRandom ? 
                            '<span class="badge badge-warning">Random</span>' : 
                            '<span class="badge badge-success">Permanent</span>'
                        }
                    </td>
                    <td>${device.manufacturer || 'Unknown'}</td>
                    <td>First seen: ${device.firstSeen}<br>Last seen: ${device.lastSeen}</td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Network scan error:', error);
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f44336;">Error scanning network. Please try again.</td></tr>';
        } finally {
            scanBtn.disabled = false;
            scanBtn.textContent = 'Scan Network';
            document.getElementById('selectAll').checked = false;
            selectedDevices.clear();
            updateActionButtons();
        }
    }

    async function scanSubnets() {
        const scanBtn = document.querySelector('.device-panel:nth-child(2) .scan-btn');
        
        try {
            scanBtn.disabled = true;
            scanBtn.textContent = 'Scanning...';
            
            // Clear existing devices
            subnetDevices.clear();
            updateSubnetTable();
            
            // Trigger the scan
            const response = await fetch('/api/scan-subnets');
            if (!response.ok) {
                throw new Error('Failed to initiate subnet scan');
            }
            
        } catch (error) {
            console.error('Subnet scan error:', error);
            const tbody = document.getElementById('subnetTableBody');
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #f44336;">
                Error scanning subnets: ${error.message}</td></tr>`;
            scanBtn.disabled = false;
            scanBtn.textContent = 'Scan Subnets';
        }
    }

    function updateSubnetTable() {
        const tbody = document.getElementById('subnetTableBody');
        
        if (subnetDevices.size === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No subnet devices found</td></tr>';
            return;
        }
        
        const tableContent = Array.from(subnetDevices.values()).map(device => `
            <tr data-ip="${device.ip}">
                <td class="checkbox-cell">
                    <input type="checkbox" 
                        class="subnet-device-checkbox" 
                        value="${device.ip}"
                        onchange="toggleDevice('${device.ip}', this.checked, true)">
                </td>
                <td>${device.subnet || 'Unknown'}</td>
                <td>${device.ip}</td>
                <td>${device.mac || 'N/A'}</td>
                <td>${device.hostname || 'Unknown'}</td>
                <td>${device.type === 'network_device' ? 'Yes' : 'No'}</td>
                <td>${formatLastSeen(device.last_seen)}</td>
            </tr>
        `).join('');
        
        tbody.innerHTML = tableContent;
        updateActionButtons(true);
    }

    // Batch Actions
    async function batchAction(action) {
        const devices = Array.from(selectedDevices);
        if (devices.length === 0) return;

        try {
            switch (action) {
                case 'rename':
                    const newName = prompt("Enter new name for selected devices:");
                    if (newName) {
                        await Promise.all(devices.map(mac => renameDevice(mac, newName)));
                    }
                    break;

                case 'trust':
                    if (confirm(`Trust ${devices.length} selected devices?`)) {
                        await Promise.all(devices.map(mac => trustDevice(mac)));
                    }
                    break;

                case 'block':
                    if (confirm(`Block ${devices.length} selected devices?`)) {
                        await Promise.all(devices.map(mac => blockDevice(mac)));
                    }
                    break;

                case 'monitor':
                    window.open('/monitor.html?devices=' + devices.join(','), '_blank');
                    break;

                case 'check':
                    const results = await Promise.all(devices.map(mac => checkDeviceState(mac)));
                    console.log('Device states:', results);
                    break;
            }

            await scanNetwork();
            selectedDevices.clear();
            updateActionButtons();

        } catch (error) {
            console.error(`Batch ${action} failed:`, error);
            alert(`Failed to ${action} devices: ${error.message}`);
        }
    }

    async function batchSubnetAction(action) {
        const devices = Array.from(selectedSubnetDevices);
        if (devices.length === 0) return;

        try {
            switch (action) {
                case 'monitor':
                    window.open('/subnetMonitor.html?devices=' + devices.join(','), '_blank');
                    break;

                case 'check':
                    const results = await Promise.all(devices.map(ip => getSubnetDeviceDetails(ip)));
                    console.log('Subnet device details:', results);
                    break;
            }

            selectedSubnetDevices.clear();
            updateActionButtons(true);

        } catch (error) {
            console.error(`Batch subnet ${action} failed:`, error);
            alert(`Failed to ${action} subnet devices: ${error.message}`);
        }
    }

    // Device Actions
    async function renameDevice(mac, newName) {
        const response = await fetch('/api/device/name', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mac, name: newName })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to rename device');
        }

        return response.json();
    }

    async function trustDevice(mac) {
        const response = await fetch('/api/devices/trust/' + mac, {
            method: 'POST'
        });

        if (!response.ok) {
            throw new Error('Failed to trust device');
        }

        return response.json();
    }

    async function blockDevice(mac) {
        const response = await fetch('/api/devices/block/' + mac, {
            method: 'POST'
        });

        if (!response.ok) {
            throw new Error('Failed to block device');
        }

        return response.json();
    }

    async function checkDeviceState(mac) {
        const response = await fetch(`/api/device/state/${mac}`);
        if (!response.ok) {
            throw new Error('Failed to check device state');
        }
        return response.json();
    }

    // Utility Functions
    function formatLastSeen(timestamp) {
        if (!timestamp) return 'Unknown';
        try {
            const date = new Date(timestamp);
            return date.toLocaleString();
        } catch (e) {
            return timestamp;
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        initializeWebSocket();
        scanNetwork();
    });
    </script>
</body>
</html>