<!DOCTYPE html>
<html>
<head>
    <title>Device Management - Network Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }

        .header {
            background: #2d2d2d;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-button {
            background: none;
            border: none;
            color: #fdfdfd;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .device-panel {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scan-btn {
            padding: 10px 20px;
            background: #4CAF50;
            border: none;
            border-radius: 4px;
            color: rgb(255, 255, 255);
            cursor: pointer;
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .device-table th,
        .device-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3d3d3d;
        }

        .device-table th {
            background: #1a1a1a;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online { background: #4CAF50; }
        .status-offline { background: #f44336; }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            color: rgb(255, 255, 255);
        }

        .scan-progress {
            margin: 10px 0;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 4px;
        }

        .progress-message {
            font-family: monospace;
            margin: 2px 0;
            padding: 2px 5px;
        }

        .progress-message.debug { color: #888; }
        .progress-message.info { color: #4CAF50; }
        .progress-message.error { color: #f44336; }

        .device-row {
            animation: fadeIn 0.5s ease-in;
        }

        .btn-monitor { background: #2196F3; }
        .btn-block { background: #f44336; }
        .btn-trust { background: #4CAF50; }
        .btn-rename { background: #FFC107; }
        .btn-check { background: #9C27B0; }

        .subnet-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 20px;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-input {
            background: #1f1f1f;
            border: 1px solid #333333;
            color: #ffffff;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 120px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        .stat-card {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #333333;
        }

        .stat-value {
            font-size: 24px;
            color: #00e676;
            margin: 10px 0;
        }

        .scan-progress {
            margin: 10px 0;
            padding: 10px;
            background: #1f1f1f;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333333;
        }

        .progress-message {
            font-family: monospace;
            margin: 2px 0;
            padding: 2px 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .progress-message.debug { color: #888; }
        .progress-message.info { color: #00e676; }
        .progress-message.error { color: #f44336; }

        .device-row {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .device-type-icon {
            margin-right: 5px;
        }


    </style>
</head>
<body>
    <div class="header">
        <button class="back-button" onclick="window.location.href='/'">
            ‚Üê Back to Dashboard
        </button>
        <h1>Device Management</h1>
    </div>

    <div class="container">
        <!-- Existing Network Devices Panel -->
        <div class="device-panel">
            <div class="panel-header">
                <h2>Network Devices</h2>
                <button class="scan-btn" onclick="scanNetwork()">Scan Network</button>
            </div>
    
            <table class="device-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Device Name</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Type</th>
                        <th>History</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="deviceTableBody">
                    <!-- Devices will be listed here -->
                </tbody>
            </table>
        </div>
    
        <!-- Enhanced Subnet Devices Panel -->
        <div class="device-panel">
            <div class="panel-header">
                <h2>Subnet Devices</h2>
                <div class="subnet-controls">
                    <div class="filters">
                        <input type="text" class="filter-input" id="ipFilter" placeholder="Filter by IP">
                        <input type="text" class="filter-input" id="macFilter" placeholder="Filter by MAC">
                        <input type="text" class="filter-input" id="hostFilter" placeholder="Filter by Hostname">
                        <select class="filter-input" id="typeFilter">
                            <option value="">All Types</option>
                            <option value="switch">Switch</option>
                            <option value="router">Router</option>
                            <option value="host">Host</option>
                        </select>
                        <button class="action-btn" onclick="clearFilters()">Clear</button>
                    </div>
                    <button class="scan-btn" onclick="scanSubnets()">Scan Subnets</button>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-card">
                    <h3>Total Devices</h3>
                    <div class="stat-value" id="totalDevices">0</div>
                </div>
                <div class="stat-card">
                    <h3>Network Devices</h3>
                    <div class="stat-value" id="networkDevices">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Subnets</h3>
                    <div class="stat-value" id="activeSubnets">0</div>
                </div>
                <div class="stat-card">
                    <h3>Last Scan</h3>
                    <div class="stat-value" id="lastScan">Never</div>
                </div>
            </div>

            <!-- Scan Progress -->
            <div class="scan-progress" id="scanProgress" style="display: none;">
                <h3>Scan Progress</h3>
                <div id="progressMessages"></div>
            </div>

            <!-- Devices Table -->
            <table class="device-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Subnet</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Hostname</th>
                        <th>Manufacturer</th>
                        <th>Response Time</th>
                        <th>Last Seen</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="subnetTableBody">
                    <!-- Subnet devices will be listed here -->
                </tbody>
            </table>
        </div>

        <script>
            let devices = [];
            let ws;
            let foundDevices = new Map();
            let scanInProgress = false;
        
            // WebSocket Connection
            function connectWebSocket() {
                ws = new WebSocket('ws://localhost:8080');
                
                ws.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    if (message.type === 'subnet_scan') {
                        handleScanMessage(message.data);
                    }
                };
        
                ws.onclose = function() {
                    console.log('WebSocket connection closed. Reconnecting...');
                    setTimeout(connectWebSocket, 1000);
                };
        
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
            }
        
            // Connect WebSocket when page loads
            connectWebSocket();
        
            function handleScanMessage(data) {
                const progressDiv = document.getElementById('scanProgress');
                const progressMessages = document.getElementById('progressMessages');
                const tbody = document.getElementById('subnetTableBody');
        
                switch (data.type) {
                    case 'device_found':
                        const device = data.device;
                        if (!foundDevices.has(device.ip)) {
                            foundDevices.set(device.ip, device);
                            addDeviceToTable(device);
                            updateStatistics();
                        }
                        break;
        
                    case 'progress':
                        const messageClass = data.message.includes('DEBUG') ? 'debug' :
                                           data.message.includes('INFO') ? 'info' : '';
                        progressMessages.insertAdjacentHTML('beforeend', `
                            <div class="progress-message ${messageClass}">${data.message}</div>
                        `);
                        progressMessages.scrollTop = progressMessages.scrollHeight;
                        break;
        
                    case 'error':
                        progressMessages.insertAdjacentHTML('beforeend', `
                            <div class="progress-message error">${data.message}</div>
                        `);
                        break;
        
                    case 'scan_complete':
                        scanInProgress = false;
                        document.querySelector('.scan-btn').disabled = false;
                        document.querySelector('.scan-btn').textContent = 'Scan Subnets';
                        document.getElementById('lastScan').textContent = new Date().toLocaleTimeString();
                        break;
                }
            }
    
            function addDeviceToTable(device) {
                const tbody = document.getElementById('subnetTableBody');
                const row = createDeviceRow(device);
                tbody.insertAdjacentHTML('beforeend', row);
            }
        
            function createDeviceRow(device) {
                return `
                    <tr class="device-row" data-ip="${device.ip}" data-type="${device.type}">
                        <td>
                            <span class="device-type-icon">${getDeviceTypeIcon(device.type)}</span>
                            ${device.type || 'Unknown'}
                        </td>
                        <td>${device.subnet || getSubnetFromIP(device.ip)}</td>
                        <td>${device.ip}</td>
                        <td>${device.mac || 'N/A'}</td>
                        <td>${device.hostname || 'Unknown'}</td>
                        <td>${device.manufacturer || 'Unknown'}</td>
                        <td>${device.response_time ? device.response_time + 'ms' : 'N/A'}</td>
                        <td>${formatDate(device.last_seen)}</td>
                        <td>
                            <button class="action-btn btn-monitor" onclick="showDeviceDetails('${device.ip}')">
                                Details
                            </button>
                            <button class="action-btn btn-trust" onclick="trustDevice('${device.ip}')">
                                Trust
                            </button>
                            <button class="action-btn btn-rename" onclick="renameDevice('${device.mac}')">
                                Rename
                            </button>
                            <button class="action-btn btn-block" onclick="blockDevice('${device.ip}')">
                                Block
                            </button>
                        </td>
                    </tr>
                `;
            }
    
            function getDeviceTypeIcon(type) {
                const icons = {
                    'switch': 'üîå',
                    'router': 'üì°',
                    'host': 'üíª',
                    'network_device': 'üñß',
                    'unknown': '‚ùì'
                };
                return icons[type] || icons.unknown;
            }
    
            function formatDate(dateString) {
                if (!dateString) return 'Unknown';
                const date = new Date(dateString);
                return date.toLocaleString();
            }
    
            function getSubnetFromIP(ip) {
                return ip.split('.').slice(0, 3).join('.') + '.0/24';
            }
        
            async function scanNetwork() {
                const scanBtn = document.querySelector('.scan-btn');
                const tbody = document.getElementById('deviceTableBody');
                
                try {
                    scanBtn.disabled = true;
                    scanBtn.textContent = 'Scanning...';
                    tbody.innerHTML = '<tr><td colspan="6">Scanning network...</td></tr>';
        
                    const response = await fetch('/api/scan-network');
                    if (!response.ok) {
                        throw new Error('Scan failed');
                    }
                    
                    const devices = await response.json();
                    
                    tbody.innerHTML = devices.map(device => `
                        <tr>
                            <td>
                                <span class="status-indicator ${device.online ? 'status-online' : 'status-offline'}"></span>
                                ${device.online ? 'Online' : 'Offline'}
                            </td>
                            <td>${device.name || device.custom_name || device.hostname || 'Unknown'}</td>
                            <td>${device.ip}</td>
                            <td>
                                ${device.mac}
                                ${device.isRandom ? 
                                    '<span class="badge badge-warning">Random</span>' : 
                                    '<span class="badge badge-success">Permanent</span>'
                                }
                            </td>
                            <td>${device.manufacturer}</td>
                            <td>First seen: ${device.firstSeen}<br>Last seen: ${device.lastSeen}</td>
                            <td>
                                <button class="action-btn btn-monitor" onclick="showDeviceHistory('${device.mac}')">
                                    History
                                </button>
                                <button class="action-btn btn-trust" onclick="trustDevice('${device.mac}')">
                                    Trust
                                </button>
                                <button class="action-btn btn-rename" onclick="renameDevice('${device.mac}')">
                                    Rename
                                </button>
                                <button class="action-btn btn-block" onclick="blockDevice('${device.mac}')">
                                    Block
                                </button>
                                <button class="action-btn btn-check" onclick="checkDeviceState('${device.mac}')">
                                    Check DB State
                                </button>
                            </td>
                        </tr>
                    `).join('');
        
                } catch (error) {
                    console.error('Scan error:', error);
                    tbody.innerHTML = '<tr><td colspan="6">Error scanning network. Please try again.</td></tr>';
                } finally {
                    scanBtn.disabled = false;
                    scanBtn.textContent = 'Scan Network';
                }
            }
        
            async function scanSubnets() {
                if (scanInProgress) return;
                
                scanInProgress = true;
                const scanBtn = document.querySelector('.scan-btn');
                const progressDiv = document.getElementById('scanProgress');
                const progressMessages = document.getElementById('progressMessages');
                
                try {
                    // Reset state
                    foundDevices.clear();
                    document.getElementById('subnetTableBody').innerHTML = '';
                    progressMessages.innerHTML = '';
                    progressDiv.style.display = 'block';
                    scanBtn.disabled = true;
                    scanBtn.textContent = 'Scanning...';
    
                    updateStatistics();
    
                    // Start the scan
                    const response = await fetch('/api/scan-subnets');
                    if (!response.ok) {
                        throw new Error('Failed to start scan');
                    }
    
                } catch (error) {
                    console.error('Subnet scan error:', error);
                    scanInProgress = false;
                    scanBtn.disabled = false;
                    scanBtn.textContent = 'Scan Subnets';
                    progressMessages.innerHTML += `
                        <div class="progress-message error">Error starting scan: ${error.message}</div>
                    `;
                }
            }
    
            function updateStatistics() {
                const devices = Array.from(foundDevices.values());
                document.getElementById('totalDevices').textContent = devices.length;
                document.getElementById('networkDevices').textContent = 
                    devices.filter(d => d.type === 'switch' || d.type === 'router' || d.type === 'network_device').length;
                
                const subnets = new Set(devices.map(d => d.subnet || getSubnetFromIP(d.ip)).filter(Boolean));
                document.getElementById('activeSubnets').textContent = subnets.size;
            }
        
            // Filter functions
            function applyFilters() {
                const ipFilter = document.getElementById('ipFilter').value.toLowerCase();
                const macFilter = document.getElementById('macFilter').value.toLowerCase();
                const hostFilter = document.getElementById('hostFilter').value.toLowerCase();
                const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
    
                const rows = document.querySelectorAll('#subnetTableBody tr');
                rows.forEach(row => {
                    const ip = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    const mac = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    const hostname = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
                    const type = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
    
                    const matchesFilter = 
                        ip.includes(ipFilter) &&
                        mac.includes(macFilter) &&
                        hostname.includes(hostFilter) &&
                        (typeFilter === '' || type.includes(typeFilter));
    
                    row.style.display = matchesFilter ? '' : 'none';
                });
            }
    
            function clearFilters() {
                document.getElementById('ipFilter').value = '';
                document.getElementById('macFilter').value = '';
                document.getElementById('hostFilter').value = '';
                document.getElementById('typeFilter').value = '';
                applyFilters();
            }
        
            // Helper functions
            async function checkDeviceState(mac) {
                try {
                    const response = await fetch(`/api/device/state/${mac}`);
                    const data = await response.json();
                    console.log('Device state:', data);
                } catch (error) {
                    console.error('Error checking device state:', error);
                }
            }
        
            async function renameDevice(mac) {
                const newName = prompt("Enter new name for device:");
                if (!newName) return;
        
                console.log('Attempting to rename device:', { mac, name: newName });
        
                try {
                    const response = await fetch('/api/device/name', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ mac, name: newName })
                    });
        
                    const data = await response.json();
                    console.log('Rename response:', data);
        
                    if (!response.ok || !data.success) {
                        throw new Error(data.error || 'Failed to update name');
                    }
        
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    await scanNetwork();
                    await checkDeviceState(mac);
                } catch (error) {
                    console.error('Error renaming device:', error);
                    alert(`Failed to rename device: ${error.message}`);
                }
            }
        
            function showDeviceDetails(ip) {
                console.log('Show details for device:', ip);
            }
        
            function monitorDevice(ip) {
                console.log('Monitoring device:', ip);
            }
        
            function trustDevice(ip) {
                console.log('Trusting device:', ip);
            }
        
            function blockDevice(ip) {
                console.log('Blocking device:', ip);
            }
        
            // Add filter event listeners
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('ipFilter')?.addEventListener('input', applyFilters);
                document.getElementById('macFilter')?.addEventListener('input', applyFilters);
                document.getElementById('hostFilter')?.addEventListener('input', applyFilters);
                document.getElementById('typeFilter')?.addEventListener('change', applyFilters);
            });
    
            // Initial scan when page loads
            scanNetwork();
        </script>
</body>
</html>